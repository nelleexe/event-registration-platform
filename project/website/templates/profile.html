{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="profile-layout">

    <div class="profile-left">
        <form id="profileForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div>
                <h3>Фото профиля</h3>

                {% if user_obj.photo %}
                <img id="avatarPreview" src="{{ user_obj.photo.url }}" width="150">
                {% else %}
                <img id="avatarPreview" src="{% static 'images/default_avatar.jpg' %}" width="150">
                {% endif %}

                <div class="photo-actions">
                    <label for="photoInput" class="btn btn-primary file-btn">
                        <input id="photoInput" type="file" name="photo" accept="image/*" hidden>
                        <p id="photoInput">Изменить фото</p>
                    </label>

                    {% if user_obj.photo %}
                    <button type="button" class="btn file-btn-secondary" onclick="removePhoto()">
                        Удалить фото
                    </button>
                    {% endif %}
                </div>
            </div>

            <hr>

            <div>
                <label>Фамилия:</label>
                {{ form.surname }}

                <label>Имя:</label>
                {{ form.name }}

                <label>Отчество:</label>
                {{ form.patronymic }}

                <label>Телефон:</label>
                {{ form.phone }}

                <label>Email:</label>
                {{ form.email }}
            </div>

            <div>
                <button type="button" id="editBtn">Редактировать</button>
                <button type="submit" id="saveBtn" style="display:none;">Сохранить</button>
                <button type="button" id="cancelBtn" style="display:none;">Отменить</button>
                <a href="/password_change/">Сменить пароль</a>
            </div>
        </form>
    </div>

    <div class="profile-right">
        <div class="profile-section">
            <h2>Мои мероприятия</h2>
            <section id="events">
                {% for event in events %}
                <article data-fancybox href="#event-{{ event.id }}-more-info" id='event-{{ event.id }}' class="event">
                    {% if event.logo %}
                    <img src="/media/{{ event.logo }}" alt="">
                    {% endif %}
                    <h2>{{ event.name }}</h2>
                </article>
                <article id='event-{{ event.id }}-more-info' class="modal">
                    <button class="modal-close" data-fancybox-close>&times;</button>
                    <h2>{{ event.name }}</h2>
                    <p>{{ event.description }}</p>
                    <p>Вы являетесь участником!</p>
                    <a href="/profile/">Отменить запись в профиле</a>
                </article>
                {% endfor %}
            </section>
        </div>
        <div class="profile-section">
            <h2>Мои кружки</h2>
            <section id="clubs">
                {% for club in clubs %}
                <article data-fancybox href="#club-{{ club.id }}-more-info" id='club-{{ club.id }}' class="club">
                    {% if club.logo %}
                    <img src="/media/{{ club.logo }}" alt="">
                    {% endif %}
                    <h2>{{ club.name }}</h2>
                </article>
                <article id='club-{{ club.id }}-more-info' class="modal">
                    <button class="modal-close" data-fancybox-close>&times;</button>
                    <h2>{{ club.name }}</h2>
                    <h3>Руководитель: {{ club.supervisor }}</h3>
                    <p>{{ club.description }}</p>
                    <p>Вы являетесь участником!</p>
                    <a href="/profile/">Отменить запись в профиле</a>
                </article>
                {% endfor %}
            </section>
        </div>
    </div>

</div>


</form>

<script>
const form = document.getElementById('profileForm');
const editBtn = document.getElementById('editBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const photoInput = document.getElementById('photoInput');
const photoEditButton = document.getElementsByClassName('file-btn');
const photoDeleteButton = document.getElementsByClassName('file-btn-secondary');
const avatarPreview = document.getElementById('avatarPreview');

const inputs = Array.from(form.querySelectorAll('input, textarea, select, button'))
    .filter(i => i.name && i.type !== 'hidden');

function setDisabled(state) {
    inputs.forEach(i => i.disabled = state);
    try {
        photoDeleteButton[0].classList.toggle('disabled');
    }
    catch {}
}

function removePhoto() {
    if (photoDeleteButton[0].classList.contains('disabled')) return;
    showConfirmation('Вы уверены, что хотите удалить фото?', 'Фото будет удалено без возможности восстановления', () => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'remove_photo';
        input.value = '1';
        form.appendChild(input);
        form.submit();
    });
}

setDisabled(true);

editBtn.addEventListener('click', () => {
    setDisabled(false);

    const emailInput = form.querySelector('input[type="email"]');
    if (emailInput) emailInput.readOnly = true;

    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline';
    cancelBtn.style.display = 'inline';
});

cancelBtn.addEventListener('click', () => {
    setDisabled(true);

    const emailInput = form.querySelector('input[type="email"]');
    if (emailInput) emailInput.readOnly = true;

    editBtn.style.display = 'inline';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';

    // Сброс превью к исходному состоянию
    {% if user_obj.photo %}
    avatarPreview.src = "{{ user_obj.photo.url }}";
    {% else %}
    avatarPreview.src = "{% static 'images/default_avatar.jpg' %}";
    {% endif %}

    // Удаление выбранного файла
    photoInput.value = '';
});

photoInput.addEventListener('change', function () {
    if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            avatarPreview.src = e.target.result;
        };
        reader.readAsDataURL(this.files[0]);
    }
});
</script>
{% endblock %}