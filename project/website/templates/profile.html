{% extends "base.html" %}

{% load static %}

{% block content %}
<form id="profileForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div>
        <h3>Фото профиля</h3>

        {% if user_obj.photo %}
        <img id="avatarPreview" src="{{ user_obj.photo.url }}" alt="Фото пользователя" width="150">
        {% else %}
        <img id="avatarPreview" src="{% static 'images/default_avatar.jpg' %}" alt="Фото пользователя" width="150">
        {% endif %}
        <br><br>

        <div class="photo-actions">
            <label for="photoInput" class="btn btn-primary file-btn">
            <input id="photoInput" type="file" name="photo" accept="image/*" hidden>Изменить фото</label>
            {% if user_obj.photo %}
            <button type="button" class="btn file-btn-secondary">Удалить фото</button>
            {% endif %}
        </div>
    </div>

    <hr>

    <div>
        <label>Фамилия:</label>
        {{ form.surname }}<br><br>

        <label>Имя:</label>
        {{ form.name }}<br><br>

        <label>Отчество:</label>
        {{ form.patronymic }}<br><br>

        <label>Телефон:</label>
        {{ form.phone }}<br><br>

        <label>Email:</label>
        {{ form.email }}<br><br>
    </div>

    <div>
        <button type="button" id="editBtn">Редактировать</button>
        <button type="submit" id="saveBtn" style="display:none;">Сохранить</button>
        <button type="button" id="cancelBtn" style="display:none;">Отменить</button>
        <a href="/password_change/" type="button" id="editBtn">Сменить пароль</a>
    </div>
</form>

<script>
const form = document.getElementById('profileForm');
const editBtn = document.getElementById('editBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const photoInput = document.getElementById('photoInput');
const photoEditButton = document.getElementsByClassName('file-btn');
const photoDeleteButton = document.getElementsByClassName('file-btn-secondary');
const avatarPreview = document.getElementById('avatarPreview');

const inputs = Array.from(form.querySelectorAll('input, textarea, select, button'))
    .filter(i => i.name && i.type !== 'hidden');

function setDisabled(state) {
    inputs.forEach(i => i.disabled = state);
    try {
        photoDeleteButton[0].classList.toggle('disabled');
    }
    catch {}
}

setDisabled(true);

editBtn.addEventListener('click', () => {
    setDisabled(false);

    const emailInput = form.querySelector('input[type="email"]');
    if (emailInput) emailInput.readOnly = true;

    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline';
    cancelBtn.style.display = 'inline';
});

cancelBtn.addEventListener('click', () => {
    location.reload();
});

photoInput.addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => avatarPreview.src = e.target.result;
    reader.readAsDataURL(file);
});
</script>
{% endblock %}